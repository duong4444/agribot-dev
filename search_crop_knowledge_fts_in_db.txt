~$ docker exec -it agri-postgres bash
:/#  psql -U postgres -d agri_chatbot
psql (15.14 (Debian 15.14-1.pgdg13+1))
Type "help" for help.

agri_chatbot=# SELECT pg_get_functiondef(oid)
FROM pg_proc
WHERE proname = 'search_crop_knowledge_fts';
                                                                                                              pg_get_functiondef
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.search_crop_knowledge_fts(search_query text, p_user_id character varying DEFAULT NULL::character varying, result_limit integer DEFAULT 10, min_rank real DEFAULT 0.01, crop_filter text DEFAULT NULL::text)+
  RETURNS TABLE(chunk_id character varying, loai_cay character varying, chu_de_lon character varying, tieu_de_chunk char
acter varying, noi_dung text, metadata jsonb, rank real, headline text)                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                            +
 AS $function$\r                                                                                                                                                                                                                              +
 DECLARE\r                                                                                                                                                                                                                                    +
   query tsquery;\r                                                                                                                                                                                                                           +
   normalized_query text;\r                                                                                                                                                                                                                   +
   normalized_crop_filter text;\r                                                                                                                                                                                                             +
   query_words text[];\r                                                                                                                                                                                                                      +
   word text;\r                                                                                                                                                                                                                               +
   or_query text;\r                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                      +
   normalized_query := normalize_vietnamese_text(search_query);\r                                                                                                                                                                             +
   \r                                                                                                                                                                                                                                         +
   IF crop_filter IS NOT NULL THEN\r                                                                                                                                                                                                          +
     normalized_crop_filter := normalize_vietnamese_text(crop_filter);\r                                                                                                                                                                      +
   END IF;\r                                                                                                                                                                                                                                  +
   \r                                                                                                                                                                                                                                         +
   query_words := string_to_array(normalized_query, ' ');\r                                                                                                                                                                                   +
   or_query := '';\r                                                                                                                                                                                                                          +
   \r                                                                                                                                                                                                                                         +
   FOREACH word IN ARRAY query_words LOOP\r                                                                                                                                                                                                   +
     IF length(word) > 2 THEN\r                                                                                                                                                                                                               +
       IF or_query = '' THEN\r                                                                                                                                                                                                                +
         or_query := word;\r                                                                                                                                                                                                                  +
       ELSE\r                                                                                                                                                                                                                                 +
         or_query := or_query || ' | ' || word;\r                                                                                                                                                                                             +
       END IF;\r                                                                                                                                                                                                                              +
     END IF;\r                                                                                                                                                                                                                                +
   END LOOP;\r                                                                                                                                                                                                                                +
   \r                                                                                                                                                                                                                                         +
   IF or_query = '' THEN\r                                                                                                                                                                                                                    +
     query := plainto_tsquery('simple', normalized_query);\r                                                                                                                                                                                  +
   ELSE\r                                                                                                                                                                                                                                     +
     query := to_tsquery('simple', or_query);\r                                                                                                                                                                                               +
   END IF;\r                                                                                                                                                                                                                                  +
   \r                                                                                                                                                                                                                                         +
   RETURN QUERY\r                                                                                                                                                                                                                             +
   SELECT \r                                                                                                                                                                                                                                  +
     ck.chunk_id,\r                                                                                                                                                                                                                           +
     ck.loai_cay,\r                                                                                                                                                                                                                           +
     ck.chu_de_lon,\r                                                                                                                                                                                                                         +
     ck.tieu_de_chunk,\r                                                                                                                                                                                                                      +
     ck.noi_dung,\r                                                                                                                                                                                                                           +
     ck.metadata,\r                                                                                                                                                                                                                           +
     (\r                                                                                                                                                                                                                                      +
       ts_rank_cd(ck.search_vector, query, 32)\r                                                                                                                                                                                              +
       *\r                                                                                                                                                                                                                                    +
       -- FIXED: Check if search_query contains field (not vice versa)\r                                                                                                                                                                      +
       CASE \r                                                                                                                                                                                                                                +
         WHEN lower(search_query) LIKE '%' || lower(ck.loai_cay) || '%' THEN 2.5\r                                                                                                                                                            +
         WHEN lower(search_query) LIKE '%' || lower(ck.tieu_de_chunk) || '%' THEN 2.0\r                                                                                                                                                       +
         WHEN lower(search_query) LIKE '%' || lower(ck.chu_de_lon) || '%' THEN 1.5\r                                                                                                                                                          +
         ELSE 1.0\r                                                                                                                                                                                                                           +
       END\r                                                                                                                                                                                                                                  +
       *\r                                                                                                                                                                                                                                    +
       CASE \r                                                                                                                                                                                                                                +
         WHEN position(normalized_query IN normalize_vietnamese_text(ck.tieu_de_chunk)) > 0 \r                                                                                                                                                +
         THEN 10.0\r                                                                                                                                                                                                                          +
         ELSE 1.0\r                                                                                                                                                                                                                           +
       END\r                                                                                                                                                                                                                                  +
     )::real AS rank,\r                                                                                                                                                                                                                       +
     ts_headline('simple', ck.noi_dung, query, 'MaxWords=50, MinWords=25, ShortWord=3, HighlightAll=false') AS headline\r                                                                                                                     +
   FROM crop_knowledge_chunks ck\r                                                                                                                                                                                                            +
   WHERE \r                                                                                                                                                                                                                                   +
     ck.search_vector @@ query\r                                                                                                                                                                                                              +
     AND ck.status = 'active'\r                                                                                                                                                                                                               +
     AND (p_user_id IS NULL OR ck.user_id = p_user_id)\r                                                                                                                                                                                      +
     AND ts_rank_cd(ck.search_vector, query) >= min_rank\r                                                                                                                                                                                    +
     AND (crop_filter IS NULL OR normalize_vietnamese_text(ck.loai_cay) LIKE '%' || normalized_crop_filter || '%')\r                                                                                                                          +
   ORDER BY rank DESC\r                                                                                                                                                                                                                       +
   LIMIT result_limit;\r                                                                                                                                                                                                                      +
 END;\r                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                   +
